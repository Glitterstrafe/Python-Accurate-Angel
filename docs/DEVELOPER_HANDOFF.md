# Project Specification: Python Accurate Angel (PAA)

**Version:** 2.0 (Event-Sourced)
**Concept:** An "AI-first" project observer that tracks code changes, visualizes relationships, and maintains project context using a "Biblically Accurate" aesthetic (Pink/Gold/Black).

---

## 1. File Structure

```text
PythonAccurateAngel/
├── angel_config.yaml         # Configuration & Theme
├── main.py                   # Entry Point
├── requirements.txt          # Dependencies
├── angel_chronicles.jsonl    # Event Log (auto-generated)
├── angel_traceability.html   # Visual Graph (auto-generated)
└── angel/                    # The Divine Modules
    ├── __init__.py
    ├── eyes.py               # File Watcher logic
    ├── voice.py              # UI & Terminal output
    ├── wheels.py             # Knowledge Graph generator
    ├── halo.py               # Safety & Budget controls
    ├── brain.py              # LLM Intent Analysis
    ├── chronicles.py         # Event Sourcing (JSONL)
    └── types.py              # Pydantic Data Models
```

---

## 2. Dependencies

**File:** `requirements.txt`

```text
watchdog==4.0.0
rich==13.7.0
networkx==3.2.1
pyvis==0.3.2
pyyaml==6.0.1
pydantic>=2.0.0
anthropic>=0.18.0
```

*Install command:* `pip install -r requirements.txt`

---

## 3. Configuration

**File:** `angel_config.yaml`

```yaml
angel_settings:
  name: "Ophanim-01"
  version: "2.0.0"

theme:
  primary: "#FF69B4"    # Hot Pink (The Mind)
  secondary: "#FFD700"  # Gold (The Glory)
  background: "#000000" # Void Black
  alert: "#FF1493"      # Deep Pink (Errors)
  text: "#FFFFFF"       # Starlight White

vision:
  watch_path: "./"
  debounce_seconds: 2.0
  ignore_patterns:
    - "*.git*"
    - "*__pycache__*"
    - "*.env"
    - "*.DS_Store"
    - "*.html"
    - "*.tmp*"
    - "*~"
    - "*.jsonl"

brain:
  provider: "mock"        # Options: mock, anthropic
  auto_confirm: true      # Set true for headless/CI mode

halo:
  max_daily_cost_usd: 1.00
  emergency_stop_file: "STOP_ANGEL"
```

---

## 4. The Modules

### A. Data Types (Pydantic Models)

**File:** `angel/types.py`

```python
from pydantic import BaseModel, Field
from typing import Literal, Optional
from datetime import datetime
import uuid


class EdgeDef(BaseModel):
    """Defines a relationship between two nodes."""
    source: str
    target: str
    edge_type: Literal["implements", "modifies", "deprecates", "relates_to"] = "relates_to"


class Proposal(BaseModel):
    """
    A proposed relationship generated by the Brain.
    Requires human confirmation before becoming truth.
    """
    proposal_id: str = Field(default_factory=lambda: str(uuid.uuid4())[:8])
    work_unit_id: str
    timestamp: str = Field(default_factory=lambda: datetime.now().isoformat())
    confidence: float = Field(ge=0.0, le=1.0)
    edge: EdgeDef
    rationale: str
    diff_summary: Optional[str] = None


class AngelEvent(BaseModel):
    """
    An immutable event in the Chronicles.
    The sequence of events IS the truth.
    """
    event_id: str = Field(default_factory=lambda: str(uuid.uuid4())[:8])
    timestamp: str = Field(default_factory=lambda: datetime.now().isoformat())
    action_type: Literal[
        "WORK_UNIT_CAPTURED",
        "PROPOSAL_GENERATED",
        "PROPOSAL_CONFIRMED",
        "PROPOSAL_REJECTED",
        "INTENT_CREATED"
    ]
    actor: Literal["Human", "AI_Agent"] = "AI_Agent"
    file_path: Optional[str] = None
    proposal_id: Optional[str] = None
    edge: Optional[EdgeDef] = None
    justification: Optional[str] = None
    explicit_approval: Optional[bool] = None
    intent_label: Optional[str] = None


class Intent(BaseModel):
    """A fuzzy human intent node (e.g., "Make it flowy", "Fix jitter")."""
    intent_id: str = Field(default_factory=lambda: str(uuid.uuid4())[:8])
    label: str
    description: Optional[str] = None
    created_at: str = Field(default_factory=lambda: datetime.now().isoformat())
```

---

### B. The Event Log (Chronicles)

**File:** `angel/chronicles.py`

```python
import json
import os
from typing import List, Optional
from pathlib import Path
from .types import AngelEvent


class TheScribe:
    """
    The Chronicles keeper. Handles append-only JSONL event storage.
    This is the ground truth - everything else is derived.
    """

    def __init__(self, chronicles_path: str = "angel_chronicles.jsonl"):
        self.chronicles_path = Path(chronicles_path)
        self._ensure_chronicles_exist()

    def _ensure_chronicles_exist(self):
        if not self.chronicles_path.exists():
            self.chronicles_path.touch()

    def record(self, event: AngelEvent) -> None:
        """Append an event to the chronicles. Atomic write."""
        with open(self.chronicles_path, "a", encoding="utf-8") as f:
            f.write(event.model_dump_json() + "\n")

    def read_all(self) -> List[AngelEvent]:
        """Read all events from the chronicles."""
        events = []
        if not self.chronicles_path.exists():
            return events

        with open(self.chronicles_path, "r", encoding="utf-8") as f:
            for line in f:
                line = line.strip()
                if line:
                    try:
                        data = json.loads(line)
                        events.append(AngelEvent(**data))
                    except (json.JSONDecodeError, ValueError):
                        continue
        return events

    def read_since(self, timestamp: str) -> List[AngelEvent]:
        """Read events after a given timestamp."""
        all_events = self.read_all()
        return [e for e in all_events if e.timestamp > timestamp]

    def get_last_event(self) -> Optional[AngelEvent]:
        """Get the most recent event."""
        events = self.read_all()
        return events[-1] if events else None

    def count(self) -> int:
        """Count total events in the chronicles."""
        return len(self.read_all())
```

---

### C. The Brain (LLM Intent Analysis)

**File:** `angel/brain.py`

```python
import os
import subprocess
from typing import Optional
from .types import Proposal, EdgeDef
import uuid


class TheBrain:
    """
    The Logic Core. Analyzes diffs and proposes relationships.
    Uses LLM to understand intent behind code changes.
    """

    def __init__(self, config: dict):
        self.config = config
        self.provider = config.get('brain', {}).get('provider', 'mock')
        self.api_key = os.environ.get('ANTHROPIC_API_KEY') or os.environ.get('OPENAI_API_KEY')

    def get_diff(self, file_path: str) -> Optional[str]:
        """Get the git diff for a file."""
        try:
            result = subprocess.run(
                ["git", "diff", "--cached", file_path],
                capture_output=True, text=True,
                cwd=os.path.dirname(file_path) or "."
            )
            if result.stdout.strip():
                return result.stdout
            result = subprocess.run(
                ["git", "diff", file_path],
                capture_output=True, text=True,
                cwd=os.path.dirname(file_path) or "."
            )
            return result.stdout if result.stdout.strip() else None
        except Exception:
            return None

    def analyze_intent(self, file_path: str, diff: Optional[str] = None) -> Proposal:
        """Analyze a code change and propose a relationship."""
        if diff is None:
            diff = self.get_diff(file_path)

        work_unit_id = str(uuid.uuid4())[:8]
        filename = os.path.basename(file_path)

        if self.provider == 'mock' or not self.api_key:
            return self._mock_analysis(filename, diff, work_unit_id)
        elif self.provider == 'anthropic':
            return self._anthropic_analysis(filename, diff, work_unit_id)
        else:
            return self._mock_analysis(filename, diff, work_unit_id)

    def _mock_analysis(self, filename: str, diff: Optional[str], work_unit_id: str) -> Proposal:
        """Mock LLM analysis for testing without API."""
        intent = self._guess_intent(filename, diff)
        return Proposal(
            work_unit_id=work_unit_id,
            confidence=0.7,
            edge=EdgeDef(source=filename, target=intent, edge_type="implements"),
            rationale=f"Detected modification in {filename}. Related to: {intent}",
            diff_summary=self._summarize_diff(diff) if diff else "No diff available"
        )

    def _guess_intent(self, filename: str, diff: Optional[str]) -> str:
        """Simple heuristic to guess intent from filename and diff."""
        filename_lower = filename.lower()
        if "test" in filename_lower:
            return "Testing & Quality"
        elif "config" in filename_lower or "yaml" in filename_lower:
            return "Configuration"
        elif "ui" in filename_lower or "voice" in filename_lower:
            return "User Interface"
        elif "api" in filename_lower or "client" in filename_lower:
            return "API Integration"
        elif "model" in filename_lower or "type" in filename_lower:
            return "Data Modeling"
        if diff:
            diff_lower = diff.lower()
            if "fix" in diff_lower or "bug" in diff_lower:
                return "Bug Fix"
            elif "add" in diff_lower or "new" in diff_lower:
                return "New Feature"
        return "General Development"

    def _summarize_diff(self, diff: str) -> str:
        """Create a brief summary of the diff."""
        lines = diff.split('\n')
        additions = sum(1 for l in lines if l.startswith('+') and not l.startswith('+++'))
        deletions = sum(1 for l in lines if l.startswith('-') and not l.startswith('---'))
        return f"+{additions}/-{deletions} lines changed"

    def _anthropic_analysis(self, filename: str, diff: Optional[str], work_unit_id: str) -> Proposal:
        """Use Claude API for intent analysis."""
        try:
            import anthropic
            client = anthropic.Anthropic(api_key=self.api_key)
            prompt = f"""Analyze this code change and determine the developer's intent.

File: {filename}
Diff:
{diff or 'No diff available'}

Respond in this exact format:
INTENT: [2-4 word description]
CONFIDENCE: [0.0-1.0]
RATIONALE: [One sentence]
EDGE_TYPE: [implements|modifies|deprecates|relates_to]"""

            message = client.messages.create(
                model="claude-sonnet-4-20250514",
                max_tokens=200,
                messages=[{"role": "user", "content": prompt}]
            )
            response = message.content[0].text
            return self._parse_llm_response(filename, response, work_unit_id, diff)
        except Exception:
            return self._mock_analysis(filename, diff, work_unit_id)

    def _parse_llm_response(self, filename: str, response: str, work_unit_id: str, diff: Optional[str]) -> Proposal:
        """Parse LLM response into a Proposal."""
        lines = response.strip().split('\n')
        intent, confidence, rationale, edge_type = "General Development", 0.7, "AI analysis", "relates_to"
        for line in lines:
            if line.startswith("INTENT:"):
                intent = line.replace("INTENT:", "").strip()
            elif line.startswith("CONFIDENCE:"):
                try:
                    confidence = float(line.replace("CONFIDENCE:", "").strip())
                except ValueError:
                    pass
            elif line.startswith("RATIONALE:"):
                rationale = line.replace("RATIONALE:", "").strip()
            elif line.startswith("EDGE_TYPE:"):
                edge_type = line.replace("EDGE_TYPE:", "").strip().lower()
        return Proposal(
            work_unit_id=work_unit_id,
            confidence=confidence,
            edge=EdgeDef(source=filename, target=intent, edge_type=edge_type),
            rationale=rationale,
            diff_summary=self._summarize_diff(diff) if diff else None
        )
```

---

### D. The Interface (Voice)

**File:** `angel/voice.py`

```python
from rich.console import Console
from rich.theme import Theme
from rich.panel import Panel
from rich.text import Text
from datetime import datetime

angel_theme = Theme({
    "angel.pink": "#FF69B4",
    "angel.gold": "#FFD700",
    "angel.alert": "bold red on #FFD700"
})

console = Console(theme=angel_theme)


class TheHerald:
    def __init__(self, name="Angel"):
        self.name = name

    def speak(self, message, style="angel.pink"):
        timestamp = datetime.now().strftime("%H:%M:%S")
        console.print(f"[{timestamp}] [bold]{self.name}:[/] {message}", style=style)

    def proclaim(self, title, content):
        text = Text(content, justify="center", style="black")
        panel = Panel(
            text,
            title=f"[bold #000000]{title}[/]",
            border_style="angel.gold",
            style="on #FF69B4",
            padding=(1, 2)
        )
        console.print(panel)

    def alert(self, message):
        console.print(f"[bold red]ALERT:[/] {message}", style="angel.gold")
```

---

### E. The Visual Graph (Wheels)

**File:** `angel/wheels.py`

```python
import networkx as nx
from pyvis.network import Network
from typing import List
from .types import AngelEvent, EdgeDef


class Sephirot:
    """
    The Knowledge Graph. State derived entirely from the Chronicles.
    """

    def __init__(self):
        self.graph = nx.DiGraph()
        self.c_file = "#FFD700"     # Gold
        self.c_intent = "#FF69B4"   # Pink
        self.c_edge = "#FFFFFF"     # White
        self.edge_colors = {
            "implements": "#00FF00",
            "modifies": "#FFA500",
            "deprecates": "#FF0000",
            "relates_to": "#FFFFFF"
        }

    def clear(self):
        self.graph.clear()

    def add_file_node(self, filename: str):
        if filename not in self.graph:
            self.graph.add_node(filename, label=filename, color=self.c_file,
                                shape="square", size=25, node_type="file")

    def add_intent_node(self, intent_label: str):
        if intent_label not in self.graph:
            self.graph.add_node(intent_label, label=intent_label, color=self.c_intent,
                                shape="dot", size=20, node_type="intent")

    def add_edge(self, edge: EdgeDef):
        self.add_file_node(edge.source)
        self.add_intent_node(edge.target)
        edge_color = self.edge_colors.get(edge.edge_type, self.c_edge)
        self.graph.add_edge(edge.source, edge.target, color=edge_color,
                            title=edge.edge_type, edge_type=edge.edge_type)

    def rebuild_from_chronicles(self, events: List[AngelEvent]):
        """Rebuild graph state from event log (Event Sourcing)."""
        self.clear()
        for event in events:
            if event.action_type == "PROPOSAL_CONFIRMED" and event.edge:
                self.add_edge(event.edge)
            elif event.action_type == "INTENT_CREATED" and event.intent_label:
                self.add_intent_node(event.intent_label)
            elif event.action_type == "WORK_UNIT_CAPTURED" and event.file_path:
                self.add_file_node(event.file_path)

    def rebuild_to_timestamp(self, events: List[AngelEvent], timestamp: str):
        """Time Travel: Rebuild to a specific point in history."""
        filtered = [e for e in events if e.timestamp <= timestamp]
        self.rebuild_from_chronicles(filtered)

    def get_stats(self) -> dict:
        nodes = list(self.graph.nodes(data=True))
        return {
            "total_nodes": len(nodes),
            "files": sum(1 for _, d in nodes if d.get("node_type") == "file"),
            "intents": sum(1 for _, d in nodes if d.get("node_type") == "intent"),
            "edges": self.graph.number_of_edges()
        }

    def manifest(self, output_file: str = "angel_traceability.html"):
        net = Network(height="750px", width="100%", bgcolor="#000000", font_color="white")
        net.from_nx(self.graph)
        net.force_atlas_2based(gravity=-50, central_gravity=0.01,
                               spring_length=100, spring_strength=0.08)
        net.save_graph(output_file)
        return output_file
```

---

### F. The Watcher (Eyes)

**File:** `angel/eyes.py`

```python
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
from threading import Timer


class TheAllSeeingEye(FileSystemEventHandler):
    def __init__(self, callback, debounce_interval=2.0, ignore_patterns=None):
        self.callback = callback
        self.debounce_interval = debounce_interval
        self.ignore_patterns = ignore_patterns or []
        self.timer = None
        self.last_event_path = None

    def _is_ignored(self, path):
        for pattern in self.ignore_patterns:
            clean_pattern = pattern.replace("*", "")
            if clean_pattern in path:
                return True
        return False

    def _process_event(self):
        if self.last_event_path:
            self.callback(self.last_event_path)

    def on_modified(self, event):
        if event.is_directory or self._is_ignored(event.src_path):
            return
        if self.timer:
            self.timer.cancel()
        self.last_event_path = event.src_path
        self.timer = Timer(self.debounce_interval, self._process_event)
        self.timer.start()


class VisionSystem:
    def __init__(self, path, callback, config):
        self.observer = Observer()
        self.handler = TheAllSeeingEye(
            callback,
            config['vision']['debounce_seconds'],
            config['vision']['ignore_patterns']
        )
        self.path = path

    def open_eyes(self):
        self.observer.schedule(self.handler, self.path, recursive=True)
        self.observer.start()

    def close_eyes(self):
        self.observer.stop()
        self.observer.join()
```

---

### G. Safety Systems (Halo)

**File:** `angel/halo.py`

```python
import os


class HaloSystem:
    def __init__(self, config):
        self.max_cost = config['halo']['max_daily_cost_usd']
        self.stop_file = config['halo']['emergency_stop_file']
        self.current_spend = 0.0

    def check_safety(self):
        if os.path.exists(self.stop_file):
            return False, "Emergency Stop File Detected!"
        if self.current_spend >= self.max_cost:
            return False, "Mana Pool Depleted (Budget Limit Reached)"
        return True, "Systems Normal"

    def record_spend(self, cost):
        self.current_spend += cost
```

---

## 5. Main Application

**File:** `main.py`

```python
import time
import yaml
import os
from rich.prompt import Prompt
from rich.table import Table

from angel.voice import TheHerald, console
from angel.eyes import VisionSystem
from angel.wheels import Sephirot
from angel.halo import HaloSystem
from angel.brain import TheBrain
from angel.chronicles import TheScribe
from angel.types import AngelEvent, EdgeDef

# Load Configuration
with open("angel_config.yaml", "r") as f:
    config = yaml.safe_load(f)

# Awaken Modules
voice = TheHerald(name=config['angel_settings']['name'])
halo = HaloSystem(config)
wheels = Sephirot()
brain = TheBrain(config)
scribe = TheScribe("angel_chronicles.jsonl")

# Rebuild state from chronicles on startup
existing_events = scribe.read_all()
if existing_events:
    wheels.rebuild_from_chronicles(existing_events)
    voice.speak(f"Restored {len(existing_events)} events from the Chronicles.", style="angel.gold")


def display_proposal(proposal):
    table = Table(title="Proposed Relationship", border_style="bright_magenta")
    table.add_column("Field", style="cyan")
    table.add_column("Value", style="white")
    table.add_row("File", proposal.edge.source)
    table.add_row("Intent", proposal.edge.target)
    table.add_row("Relationship", proposal.edge.edge_type)
    table.add_row("Confidence", f"{proposal.confidence:.0%}")
    table.add_row("Rationale", proposal.rationale)
    if proposal.diff_summary:
        table.add_row("Changes", proposal.diff_summary)
    console.print(table)


def handle_change(file_path):
    is_safe, msg = halo.check_safety()
    if not is_safe:
        voice.alert(f"HALO INTERVENTION: {msg}")
        return

    filename = os.path.basename(file_path)
    voice.speak(f"I perceive a shift in: [u]{filename}[/u]", style="angel.gold")

    # Record work unit
    scribe.record(AngelEvent(action_type="WORK_UNIT_CAPTURED", file_path=filename))

    # Analyze intent
    proposal = brain.analyze_intent(file_path)
    scribe.record(AngelEvent(action_type="PROPOSAL_GENERATED", file_path=filename,
                             proposal_id=proposal.proposal_id))

    # Display proposal
    console.print()
    display_proposal(proposal)
    console.print()

    # Get confirmation (or auto-confirm)
    auto_confirm = config.get('brain', {}).get('auto_confirm', False)
    if auto_confirm:
        voice.speak("Auto-confirm enabled. Accepting proposal.", style="angel.gold")
        choice = "y"
    else:
        choice = Prompt.ask("[bold magenta]Link this relationship?[/]",
                            choices=["y", "n", "e"], default="y")

    if choice == "y":
        scribe.record(AngelEvent(
            action_type="PROPOSAL_CONFIRMED", actor="Human", file_path=filename,
            proposal_id=proposal.proposal_id, edge=proposal.edge,
            explicit_approval=True, justification=proposal.rationale
        ))
        wheels.add_edge(proposal.edge)
        voice.speak("Relationship confirmed and recorded.", style="angel.pink")

    elif choice == "n":
        scribe.record(AngelEvent(
            action_type="PROPOSAL_REJECTED", actor="Human", file_path=filename,
            proposal_id=proposal.proposal_id, explicit_approval=False
        ))
        voice.speak("Proposal rejected.", style="angel.gold")

    elif choice == "e":
        custom_intent = Prompt.ask("[bold cyan]Enter your intent (2-4 words)[/]")
        if custom_intent.strip():
            custom_edge = EdgeDef(source=filename, target=custom_intent.strip(),
                                  edge_type="implements")
            scribe.record(AngelEvent(
                action_type="PROPOSAL_CONFIRMED", actor="Human", file_path=filename,
                proposal_id=proposal.proposal_id, edge=custom_edge,
                explicit_approval=True, justification=f"Human override: {custom_intent}"
            ))
            wheels.add_edge(custom_edge)
            voice.speak(f"Custom link: {filename} → {custom_intent}", style="angel.pink")

    # Update visualization
    wheels.manifest()
    stats = wheels.get_stats()
    voice.speak(f"Constellation: {stats['files']} files, {stats['intents']} intents, "
                f"{stats['edges']} links", style="angel.pink")


def main():
    auto_confirm = config.get('brain', {}).get('auto_confirm', False)
    mode_text = "AUTO-CONFIRM MODE" if auto_confirm else "[Y]es / [N]o / [E]dit"

    voice.proclaim(
        "BE NOT AFRAID",
        f"Python Accurate Angel v{config['angel_settings']['version']} is hovering.\n"
        f"Watching: {os.path.abspath(config['vision']['watch_path'])}\n"
        f"{mode_text}"
    )

    stats = wheels.get_stats()
    if stats['total_nodes'] > 0:
        voice.speak(f"Current: {stats['files']} files, {stats['intents']} intents",
                    style="angel.gold")

    eyes = VisionSystem(path=config['vision']['watch_path'],
                        callback=handle_change, config=config)
    eyes.open_eyes()

    try:
        while True:
            time.sleep(1)
            is_safe, msg = halo.check_safety()
            if not is_safe:
                voice.alert(f"SHUTTING DOWN: {msg}")
                break
    except KeyboardInterrupt:
        voice.speak("\nReturning to the ether...", style="angel.pink")
    finally:
        eyes.close_eyes()
        stats = wheels.get_stats()
        voice.speak(f"Final: {stats['files']} files, {stats['intents']} intents, "
                    f"{stats['edges']} links", style="angel.gold")


if __name__ == "__main__":
    main()
```

---

## 6. How to Run

### Interactive Mode (Human-in-the-Loop)
```bash
cd PythonAccurateAngel
# Set auto_confirm: false in angel_config.yaml
python main.py
```

### Headless/CI Mode (Auto-Confirm)
```bash
cd PythonAccurateAngel
# Set auto_confirm: true in angel_config.yaml
python main.py
```

### With Claude API
```bash
export ANTHROPIC_API_KEY="your-key-here"
# Set provider: "anthropic" in angel_config.yaml
python main.py
```

---

## 7. Architecture Summary

| Module | Role | Key Feature |
|--------|------|-------------|
| **eyes.py** | File Watcher | Debounced event detection |
| **brain.py** | Intent Analysis | LLM or heuristic proposals |
| **chronicles.py** | Event Log | Append-only JSONL (ground truth) |
| **wheels.py** | Graph Builder | Rebuilds from events, time travel |
| **voice.py** | Terminal UI | Rich pink/gold output |
| **halo.py** | Safety | Budget limits, kill switch |
| **types.py** | Data Models | Pydantic schemas |

---

## 8. Roadmap

- [x] **Phase 1:** File Watching, Graph Visualization, Safety Halo
- [x] **Phase 2:** Event Sourcing, Pydantic Types, LLM Brain, Auto-Confirm
- [ ] **Phase 3:** Full LLM Integration (Claude/GPT analysis)
- [ ] **Phase 4:** Time Travel UI (replay historical graph states)
- [ ] **Phase 5:** Multi-project support, VS Code extension

---

## 9. License

**MIT License** - Free to use, fork, and build upon.

*The Angel watches all.*
